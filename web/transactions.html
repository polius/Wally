<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wally | Transactions</title>
  <link rel="icon" type="image/png" href="assets/wally.png">
  <meta name="robots" content="index,follow" />
  <meta name="description" content="A lightweight, self-hosted expense tracker that makes it easy to manage your finances." />
  <meta property="author" content="Pol Alzina" />
  <meta property="og:title" content="Wally" />
  <meta property="og:description" content="A lightweight, self-hosted expense tracker that makes it easy to manage your finances." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="assets/wally.png" />
  <!-- CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/tom-select.min.css" rel="stylesheet">
  <link href="css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <!-- JS -->
  <script src="js/bootstrap.bundle.min.js" defer></script>
  <script src="js/bootstrap-show-toast.js" defer></script>
  <script src="js/ag-grid-community.min.noStyle.js" defer></script>
  <script src="js/tom-select.complete.min.js" defer></script>
  <script src="js/decimal.min.js" defer></script>

  <script>
    (function() {
      const theme = localStorage.getItem('theme') || 'system';
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (theme === 'light' || (theme === 'system' && !systemPrefersDark)) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
      else {
        document.documentElement.setAttribute('data-bs-theme', 'dark');
      }
    })();
  </script>

  <style>
    :root[data-bs-theme="light"] {
      --header-bg: #f8f8f8;
      --pill-bg: #f4f4f7;
      --pill-color: #000;
    }
    :root[data-bs-theme="dark"] {
      --header-bg: #262a2e;
      --pill-bg: #282c30;
      --pill-color: #FFF;
    }
    header {
      background-color: var(--header-bg);
    }

    input, .option {
      color: var(--pill-color)!important;
    }

    .ts-control .item {
      background-color: var(--pill-bg)!important;
      color: var(--pill-color)!important;
    }

    .ts-control .item .remove {
      border-color: var(--header-bg)!important;
    }

    #tagsInput-ts-dropdown .create, #tagsInput-ts-dropdown .no-results {
      color: var(--pill-color)!important;
    }

    .form-check-input {
      background-color: white;
    }

    .text-green {
      color: #198754;
    }

    .text-red {
      color: #ea4152;
    }

    .ag-cell {
      display: flex;
      align-items: center;
      height: 100%;
      line-height: 1.7;
      padding-top: 4px;
      padding-bottom: 4px;
    }

    /* Hide button text on small screens */
    @media (max-width: 768px) {
      .action-button-text {
        display: none !important;
      }
      .action-button-mobile {
        width: 32px !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-right: 4px !important;
        margin-left: 4px !important;
      }
    }

    .ag-header-cell-label {
      font-weight: 600;
    }

    .month-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .current-month {
      font-size: 1.6rem;
      font-weight: bold;
      min-width: 200px;
      text-align: center;
    }

    #prevMonth, #nextMonth {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 40px;
      border-radius: 24px;
      cursor: pointer;
      color: var(--pill-color);
      position: relative;
      /* No border or background */
      border: 2px solid transparent;
      background-color: transparent;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    #prevMonth:hover, #nextMonth:hover {
      background-color: #cce4ff;
      border-color: #4a90e2;
      color: #004aad;
    }

    body {
      display: flex;
      flex-direction: column;
      height: calc(var(--vh, 1vh) * 100);
    }

    main.container {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      padding-top: 1rem;
      padding-bottom: 1rem;
      overflow: hidden;
    }

    #myGrid {
      flex: 1 1 auto;
      min-height: 0;
      width: 100%;
    }

    .btn-action {
      font-size: 0.9rem;
      height: 40px;
      border-radius: 100px;
      white-space: nowrap;
      width: 150px;
    }

    .btn-action svg {
      margin-right: 8px;
    }

    /* Mobile: Compact when delete button is shown */
    @media (max-width: 767px) {
      .compact-buttons .btn-action {
        font-size: 0.8rem;
        height: 36px;
        width: 120px;
      }

      .compact-buttons .btn-action svg {
        width: 13px;
        height: 13px;
        margin-right: 6px;
      }
    }

    @media (max-width: 400px) {
      .compact-buttons .btn-action {
        font-size: 0.75rem;
        height: 34px;
        width: 105px;
      }

      .compact-buttons .btn-action svg {
        width: 12px;
        height: 12px;
        margin-right: 5px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light">
        <a class="navbar-brand d-flex align-items-center" style="margin-left:10px; margin-right:30px" href="/">
          <img src="assets/wally.png" alt="Wally" width="50" height="50" style="margin-bottom: 5px; margin-right: 8px;">
          <span style="font-size: 1.8rem; font-weight:600;">Wally</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item" style="margin-left: 10px"><a class="nav-link" href="/">Dashboards</a></li>
            <li class="nav-item" style="margin-left: 10px"><a class="nav-link active" href="transactions" style="font-weight: 500">Transactions</a></li>
            <li class="nav-item" style="margin-left: 10px"><a class="nav-link" href="settings">Settings</a></li>
          </ul>
          <ul id="logoutButton" class="navbar-nav ms-auto" style="display: none;">
            <li class="nav-item nav-link" style="margin-left: 10px; cursor: pointer;" title="Logout" onclick="logout()">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--pill-color)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                <path d="M9 12h12l-3 -3" />
                <path d="M18 15l3 -3" />
              </svg>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container my-2">

    <!-- Month Header -->
    <div id="monthHeader" class="month-navigation">
      <div id="prevMonth" style="cursor: pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="22" height="22" fill="currentColor">
          <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 288 480 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-370.7 0 105.4-105.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/>
        </svg>
      </div>
      <div id="currentMonth" class="current-month"></div>
      <div id="nextMonth" style="cursor: pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="22" height="22" fill="currentColor">
          <path d="M502.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l370.7 0-105.4 105.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/>
        </svg>
      </div>
    </div>

    <div id="monthHeaderAll" class="month-navigation" style="display: none; height: 40px">
      <div class="current-month">All Transactions</div>
    </div>

    <!-- Action buttons -->
    <div id="actionButtonsContainer" class="d-flex flex-wrap justify-content-center align-items-center mb-4" style="margin-top: 20px; gap: 5px;">
      <button type="button" class="btn btn-success d-flex align-items-center justify-content-center btn-action" data-bs-toggle="modal" data-bs-target="#transactionModal" onclick="addTransaction()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor">
          <path d="M256 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 160-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0 0-160z"/>
        </svg>
        <span class="btn-text">Add</span>
      </button>
      <button id="deleteSelectedBtn" type="button" class="btn btn-danger align-items-center justify-content-center btn-action" style="display:none;" onclick="deleteSelectedTransactions()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor">
          <path d="M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z"/>
        </svg>
        <span class="btn-text">Delete (</span><span id="selectedCount">0</span><span class="btn-text">)</span>
      </button>
      <div class="d-flex justify-content-center">
        <label class="btn btn-primary d-flex align-items-center gap-2 justify-content-center btn-action" style="user-select:none; cursor:pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="currentColor">
            <path d="M40 48C26.7 48 16 58.7 16 72l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24L40 48zM192 64c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L192 64zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-288 0zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-288 0zM16 232l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24l-48 0c-13.3 0-24 10.7-24 24zM40 368c-13.3 0-24 10.7-24 24l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24l-48 0z"/>
          </svg>
          <span class="btn-text">Show All</span>
          <input id="showAllTransactions" type="checkbox" class="form-check-input" style="margin: 0; display: none;" onchange="getTransactions()" />
        </label>
      </div>
    </div>

    <!-- Grid Filter -->
    <div class="mb-2">
      <input type="text" class="form-control" id="searchInput" placeholder="Search..."  oninput="onFilterTextBoxChanged()" />
    </div>

    <!-- AG Grid Table -->
    <div id="myGrid"></div>

    <!-- AG Grid Table Footer -->
    <div id="myGridFooter" class="mt-3" style="text-align: center; font-size: 0.9rem; font-weight: 400">
      <span style="white-space: nowrap;">Rows: <span id="rowCount" style="font-weight: 500; color:#007AFF">0</span></span> <span style="padding-left: 3px; padding-right:3px; font-weight: 100">|</span> <span style="white-space: nowrap;">Income: <span id="incomeAmount" style="font-weight: 500; color: #198754">0</span></span> <span style="padding-left: 3px; padding-right:3px; font-weight: 100">|</span> <span style="white-space: nowrap;">Expense: <span id="expenseAmount" style="font-weight: 500; color:#ea4152">0</span></span>
    </div>
  </main>

  <!-- Transaction Modal (Add and Edit) -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="transactionForm" class="modal-content" onsubmit="submitTransaction(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Name -->
          <div class="mb-3">
            <label for="nameInput" class="form-label">Name</label>
            <input type="text" class="form-control" id="nameInput" name="name" placeholder="Enter name" required />
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label for="categorySelect" class="form-label">Category</label>
            <select class="form-select" id="categorySelect" name="category" required></select>
          </div>

          <!-- Tags -->
          <div class="mb-3">
            <label class="form-label">Tags</label>
            <input id="tagsInput" name="tags" type="text" class="form-control" value="" placeholder="Add a tag and press Enter" autocomplete="off">
          </div>

          <!-- Amount -->
          <div class="mb-3">
            <label for="amountInput" class="form-label">Amount</label>
            <input type="text" inputmode="decimal" class="form-control" id="amountInput" name="amount" min="0.01" step="0.01" required />
          </div>

          <!-- Type -->
          <div class="mb-3">
            <label for="typeSelect" class="form-label">Type</label>
            <select class="form-select" id="typeSelect" name="type" required>
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>

          <!-- Date -->
          <div>
            <label for="dateInput" class="form-label">Date</label>
            <input type="date" class="form-control" id="dateInput" name="date" required />
          </div>

          <!-- Recurring -->
          <div id="recurringElement" class="form-check mt-3">
            <input class="form-check-input" type="checkbox" value="" id="recurringCheck" name="recurringCheck" onchange="toggleRecurring(event.target.checked)" />
            <label class="form-check-label" for="recurringCheck">
              Recurring
            </label>
          </div>

          <div id="recurringDiv" class="card mt-3" style="display: none;">
            <div class="card-body">
              <div class="row">
                <!-- Start Date -->
                <div class="col-6 mb-3">
                  <label for="startDateInput" class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="startDateInput" name="startDate" />
                </div>
                <!-- End Date -->
                <div class="col-6 mb-3">
                  <label for="endDateInput" class="form-label">End Date</label>
                  <input type="date" class="form-control" id="endDateInput" name="endDate" />
                </div>
              </div>

              <!-- Frequency -->
              <div>
                <label for="frequencySelect" class="form-label">Frequency</label>
                <select class="form-select" id="frequencySelect" name="frequency">
                  <option value="" disabled selected>Select frequency</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width: 120px">Cancel</button>
          <button type="submit" class="btn btn-success" id="modalSubmitButton" style="width: 120px">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction Modal Delete -->
  <div class="modal fade" id="transactionModalDelete" tabindex="-1" aria-labelledby="transactionModalDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" onsubmit="submitTransaction(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalDeleteLabel">Delete Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this transaction?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width: 120px">Cancel</button>
          <button type="submit" class="btn btn-danger" style="width: 120px">Delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction Modal Delete Multiple -->
  <div class="modal fade" id="transactionModalDeleteMultiple" tabindex="-1" aria-labelledby="transactionModalDeleteMultipleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" onsubmit="submitTransactionDeleteMultiple(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalDeleteMultipleLabel">Delete Transactions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete <strong><span id="deleteMultipleCount">0</span></strong> transaction<span id="deleteMultiplePlural">s</span>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width: 120px">Cancel</button>
          <button type="submit" class="btn btn-danger" style="width: 120px">Delete</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    const API_URL = '/api'; // 'http://127.0.0.1:8000';

    let categories;
    let tags;
    let currency;

    let gridInstance;
    let gridApi;

    let modalMode = 'add';
    let selectedRow;

    let currentDate = new Date();
    let tagsInput;

    // Execute the main function when DOM has loaded
    document.addEventListener('DOMContentLoaded', () => main());
    
    async function main() {
      await checkLogin();

      // Show current month
      renderMonth();

      // Get categories, tags and default currency
      [categories, tags, currency] = await Promise.all([
        getCategories(),
        getTags(),
        getCurrency(),
      ]);

      // Render categories and tags
      await renderCategories();
      await renderTags();

      // Initialize the grid
      gridApi = await initGrid();

      // Set Viewport Height (for mobile devices)
      window.addEventListener('load', setViewportHeight);
      window.addEventListener('resize', setViewportHeight);
      setViewportHeight();
    }

    function setViewportHeight() {
      let vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    async function getCategories() {
      const response = await fetch(`${API_URL}/categories`, {
        method: 'GET',
        credentials: 'include',
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const data = await response.json();
      return data;
    }

    async function getTags() {
      const response = await fetch(`${API_URL}/tags`, {
        method: 'GET',
        credentials: 'include',
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const data = await response.json();
      return data;
    }

    async function getCurrency() {
      const response = await fetch(`${API_URL}/currency`, {
        method: 'GET',
        credentials: 'include',
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const data = await response.json();
      return data.filter(x => x.selected)[0];
    }

    async function renderCategories() {
      const select = document.getElementById('categorySelect');

      // Clear any existing options
      select.innerHTML = "";

      // First static placeholder option
      const placeholder = document.createElement('option');
      placeholder.value = "";
      placeholder.textContent = "Select category";
      placeholder.selected = true;
      placeholder.disabled = true;
      select.appendChild(placeholder);

      // Then your dynamic options
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        option.selected = false;
        select.appendChild(option);
      });
    }

    async function renderTags() {
      tagsInput = new TomSelect('#tagsInput', {
        plugins: {
          remove_button: {
            title: 'Remove this tag',
          }
        },
        persist: false,
        create: true,
        render: {
          no_results: function(data, escape) {
            return '';
          },
        }
      });

      tags.forEach(tag => {
        tagsInput.addOption({ value: tag, text: tag }, user_created=false);
      });
    }

    async function initGrid() {
      let myTheme;
      const theme = localStorage.getItem('theme') || 'system';
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (theme === 'light' || (theme === 'system' && !systemPrefersDark)) {
        myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeLightWarm);
      }
      else {
        myTheme = agGrid.themeQuartz.withParams({
          backgroundColor: '#212529',
          foregroundColor: '#b5b9bd',
          headerTextColor: '#b5b9bd',
          headerBackgroundColor: '#272b30',
          oddRowBackgroundColor: '#272b30',
          headerColumnResizeHandleColor: '#b5b9bd',
        });
      }

      const gridOptions = {
        theme: myTheme,
        suppressMovableColumns: true,
        rowData: [],
        rowSelection: 'multiple',
        suppressRowClickSelection: true,
        defaultColDef: {
          flex: 1,
          minWidth: 150,
        },
        onGridReady: params => {
          gridApi = params.api;
          getTransactions();
        },
        onFilterChanged: params => {
          updateFooter(params.api);
        },
        onSelectionChanged: () => {
          updateDeleteButton();
        },
        columnDefs: [
          {
            headerCheckboxSelection: true,
            checkboxSelection: true,
            width: 50,
            minWidth: 50,
            maxWidth: 50,
            suppressMenu: true,
            filter: false,
            resizable: false,
          },
          {
            field: "name",
            filter: true,
            wrapText: true,
            autoHeight: true,
            cellRenderer: (params) => {
              const container = document.createElement('span');
  
              if (params.data?.recurringID) {
                // SVG icon
                container.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="10" height="10" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M488 192l-144 0c-9.7 0-18.5-5.8-22.2-14.8s-1.7-19.3 5.2-26.2l46.7-46.7c-75.3-58.6-184.3-53.3-253.5 15.9-75 75-75 196.5 0 271.5s196.5 75 271.5 0c8.2-8.2 15.5-16.9 21.9-26.1 10.1-14.5 30.1-18 44.6-7.9s18 30.1 7.9 44.6c-8.5 12.2-18.2 23.8-29.1 34.7-100 100-262.1 100-362 0S-25 175 75 75c94.3-94.3 243.7-99.6 344.3-16.2L471 7c6.9-6.9 17.2-8.9 26.2-5.2S512 14.3 512 24l0 144c0 13.3-10.7 24-24 24z"/>
                  </svg>
                `;
                // Add the name text after the SVG
                const nameSpan = document.createElement('span');
                nameSpan.textContent = params.data?.name;
                container.appendChild(nameSpan);
              } else {
                // Just the name if no recurringID
                container.textContent = params.data?.name;
              }
              return container;
            }
          },
          {
            field: "category",
            filter: true,
          },
          {
            field: "tags",
            filter: true,
            valueFormatter: (params) => {
              return params.value ? params.value.join(", ") : "";
            },
          },
          {
            field: "date",
            valueFormatter: (params) => {
              const [year, month, day] = params.value.split("-");
              const date = new Date(Number(year), Number(month) - 1, Number(day));
              return new Intl.DateTimeFormat('en-US', {
                weekday: 'short',  // "Mon"
                month: 'short',    // "Aug"
                day: 'numeric',    // 4
                year: 'numeric'    // 2025
              }).format(date);
            }
          },
          {
            field: "amount",
            valueFormatter: (params) => {
              const amount = params.value;
              const sign = params.data?.type === 'expense' ? '-' : '';
              
              if (currency.position === 'left') {
                return `${sign}${currency.symbol}${amount}`;
              }
              else {
                return `${sign}${amount} ${currency.symbol}`;
              }
            },
            cellClass: (params) => {
              if (params.data?.type === 'income') return 'text-green';
              if (params.data?.type === 'expense') return 'text-red';
            },
            comparator: (valueA, valueB, nodeA, nodeB, isInverted) => {             
              const aData = nodeA.data;
              const bData = nodeB.data;
              
              // Calculate "sort value" for aData.amount based on type
              const aVal = (aData.type === 'expense' ? -aData.amount : aData.amount);
              const bVal = (bData.type === 'expense' ? -bData.amount : bData.amount);

              // Normal numeric compare
              if (aVal < bVal) return -1;
              if (aVal > bVal) return 1;
              return 0;
            }
          },
          { 
            field: "actions",
            width: 100,
            cellRenderer: (params) => {
              const container = document.createElement("div");
              container.style.display = "flex";
              container.style.alignItems = "center";

              // Edit button
              const editButton = document.createElement("span");
              editButton.className = "action-button-mobile";
              editButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="currentColor" style="display: inline-block; vertical-align: middle;">
                  <path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L368 46.1 465.9 144 490.3 119.6c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L432 177.9 334.1 80 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z"/>
                </svg>
                <span class="action-button-text" style="margin-left: 6px; font-size: 14px;">Edit</span>
              `;
              editButton.style.display = "flex";
              editButton.style.justifyContent = "center";
              editButton.style.alignItems = "center";
              editButton.style.height = "32px";
              editButton.style.paddingLeft = "8px";
              editButton.style.paddingRight = "10px";
              editButton.style.borderRadius = "6px";
              editButton.style.cursor = "pointer";
              editButton.style.marginRight = "8px";
              editButton.style.color = "#3d8bfd";
              editButton.style.transition = "all 0.2s ease";
              editButton.style.backgroundColor = "transparent";
              editButton.style.lineHeight = "0";
              editButton.title = "Edit Transaction";

              editButton.addEventListener("mouseenter", () => {
                editButton.style.color = "#0d6efd";
                editButton.style.backgroundColor = "rgba(13, 110, 253, 0.15)";
              });
              editButton.addEventListener("mouseleave", () => {
                editButton.style.color = "#3d8bfd";
                editButton.style.backgroundColor = "transparent";
              });
              editButton.addEventListener("click", () => {
                selectedRow = params.data;
                editTransaction()
              });

              // Delete button
              const deleteButton = document.createElement("span");
              deleteButton.className = "action-button-mobile";
              deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="15" height="15" fill="currentColor" style="display: inline-block; vertical-align: middle;">
                  <path d="M136.7 5.9C141.1-7.2 153.3-16 167.1-16l113.9 0c13.8 0 26 8.8 30.4 21.9L320 32 416 32c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 96C14.3 96 0 81.7 0 64S14.3 32 32 32l96 0 8.7-26.1zM32 144l384 0 0 304c0 35.3-28.7 64-64 64L96 512c-35.3 0-64-28.7-64-64l0-304zm88 64c-13.3 0-24 10.7-24 24l0 192c0 13.3 10.7 24 24 24s24-10.7 24-24l0-192c0-13.3-10.7-24-24-24zm104 0c-13.3 0-24 10.7-24 24l0 192c0 13.3 10.7 24 24 24s24-10.7 24-24l0-192c0-13.3-10.7-24-24-24zm104 0c-13.3 0-24 10.7-24 24l0 192c0 13.3 10.7 24 24 24s24-10.7 24-24l0-192c0-13.3-10.7-24-24-24z"/>
                </svg>
                <span class="action-button-text" style="margin-left: 6px; font-size: 14px;">Delete</span>
              `;
              deleteButton.style.display = "flex";
              deleteButton.style.justifyContent = "center";
              deleteButton.style.alignItems = "center";
              deleteButton.style.height = "32px";
              deleteButton.style.paddingLeft = "8px";
              deleteButton.style.paddingRight = "10px";
              deleteButton.style.borderRadius = "6px";
              deleteButton.style.cursor = "pointer";
              deleteButton.style.marginLeft = "8px";
              deleteButton.style.color = "#e35d6a";
              deleteButton.style.transition = "all 0.2s ease";
              deleteButton.style.backgroundColor = "transparent";
              deleteButton.style.lineHeight = "0";
              deleteButton.title = "Delete Transaction";

              deleteButton.addEventListener("mouseenter", () => {
                deleteButton.style.color = "#dc3545";
                deleteButton.style.backgroundColor = "rgba(220, 53, 69, 0.15)";
              });
              deleteButton.addEventListener("mouseleave", () => {
                deleteButton.style.color = "#e35d6a";
                deleteButton.style.backgroundColor = "transparent";
              });
              deleteButton.addEventListener("click", () => {
                selectedRow = params.data;
                deleteTransaction()
              });

              container.appendChild(editButton);
              container.appendChild(deleteButton);

              return container;
            }
          }
        ]
      }

      // Destroy existing grid instance if it exists
      if (gridInstance) {
        gridInstance.destroy();
      }

      // Creating the AG Grid
      const myGridElement = document.querySelector('#myGrid');
      gridInstance = agGrid.createGrid(myGridElement, gridOptions);
    }

    function renderMonth() {
      document.getElementById('currentMonth').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    function onFilterTextBoxChanged() {
      gridApi.setGridOption("quickFilterText", document.getElementById("searchInput").value);
    }

    async function getTransactions() {
      const showAll = document.getElementById('showAllTransactions').checked;
      const monthHeader = document.getElementById('monthHeader');
      const monthHeaderAll = document.getElementById('monthHeaderAll');

      if (showAll) {
        monthHeader.style.display = 'none';
        monthHeaderAll.style.display = 'flex';

        // Fetch all transactions
        const response = await fetch(`${API_URL}/transactions`, {
          method: 'GET',
          credentials: 'include',
        });

        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const data = await response.json()
        gridApi.setGridOption('rowData', data)
      }
      else {
        monthHeader.style.display = 'flex';
        monthHeaderAll.style.display = 'none';

        // Fetch only current month transactions
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const year = currentDate.getFullYear(); // 2025
        const response = await fetch(`${API_URL}/transactions/date/${year}-${month}`, {
          method: 'GET',
          credentials: 'include',
        });

        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const data = await response.json()
        gridApi.setGridOption('rowData', data)
      }
      updateFooter(gridApi);
    }

    // Prev month button
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderMonth();
      getTransactions();
    });

    // Next month button
    document.getElementById('nextMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderMonth();
      getTransactions();
    });

    document.getElementById('transactionModal').addEventListener('shown.bs.modal', () => {
      document.getElementById('nameInput').focus()
    });

    document.getElementById('amountInput').addEventListener('input', (event) => {
      if (event.target.value.includes(',')) {
        event.target.value = event.target.value.replace(',', '.');
      }
    });

    function updateFooter(api) {
      const rowCount = api.getDisplayedRowCount();

      // Get total expense amount using AG Grid API
      let income = 0;
      let expense = 0;
      api.forEachNodeAfterFilterAndSort(node => {
        if (node.data.type === 'income') income = Decimal.add(income, node.data.amount).toNumber();
        else if (node.data.type === 'expense') expense = Decimal.add(expense, node.data.amount).toNumber();
      });

      if (currency.position === 'left') {
        income = `${currency.symbol}${income}`;
        expense = `${currency.symbol}${expense}`;
      }
      else {
        income = `${income} ${currency.symbol}`;
        expense = `${expense} ${currency.symbol}`;
      }

      // Update footer values
      document.getElementById('rowCount').innerText = rowCount;
      document.getElementById('incomeAmount').innerText = income;
      document.getElementById('expenseAmount').innerText = expense;
    }

    function addTransaction() {
      modalMode = 'add';
      document.getElementById('transactionModalLabel').textContent = 'Add Transaction';
      document.getElementById('modalSubmitButton').textContent = 'Add';
      document.getElementById('transactionForm').reset();
      document.getElementById('categorySelect').value = "";
      tagsInput.setValue([]);
      document.getElementById('dateInput').value = new Date().toLocaleDateString("en-CA"); // YYYY-MM-DD (Local time)
      document.getElementById('recurringElement').style.display = 'block';
      toggleRecurring(false);
    }

    function editTransaction() {
      modalMode = 'edit';
      document.getElementById('transactionModalLabel').textContent = 'Edit Transaction';
      document.getElementById('modalSubmitButton').textContent = 'Edit';
      document.getElementById('recurringElement').style.display = 'none';
      toggleRecurring(false);

      // Assign values
      document.getElementById('nameInput').value = selectedRow.name
      document.getElementById('categorySelect').value = selectedRow.category
      selectedRow.tags.forEach(tag => {
        tagsInput.addOption({ value: tag, text: tag }, user_created=true);
      });
      tagsInput.setValue(selectedRow.tags);
      document.getElementById('amountInput').value = selectedRow.amount
      document.getElementById('typeSelect').value = selectedRow.type
      document.getElementById('dateInput').value = selectedRow.date

      // Open modal
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('transactionModal'));
      modal.show();
    }

    function deleteTransaction() {
      modalMode = 'delete';
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('transactionModalDelete'));
      modal.show();
    }

    function submitTransaction(event) {
      if (modalMode === 'add') {
        if (event.target.recurringCheck.checked) submitRecurringAdd(event);
        else submitTransactionAdd(event);
      }
      else if (modalMode === 'edit') submitTransactionEdit(event);
      else if (modalMode === 'delete') submitTransactionDelete(event);
    }

     async function submitRecurringAdd(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData.entries());
      data.tags = data.tags ? data.tags.split(',').map(tag => tag.trim()) : [];

      // Check if startDate is before endDate
      if (new Date(data.startDate) >= new Date(data.endDate)) {
        bootstrap.showToast({body: 'The end date must be later than the start date.', delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"});
        return;
      }

      try {
        const response = await fetch(`${API_URL}/recurring`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const json = await response.json()

        if (!response.ok) {
          if (response.status === 422) throw new Error(json.detail[0].msg)
          throw new Error("An error occurred.")
        }
        else {
          // Hide the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
          modal.hide();

          // Show toast
          bootstrap.showToast({body: 'Recurring transaction added.', delay: 1000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-success"})

          // Refresh the grid
          getTransactions();
        }
      }
      catch (error) {
        bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
      }
    }

    async function submitTransactionAdd(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData.entries());
      data.tags = data.tags ? data.tags.split(',').map(tag => tag.trim()) : [];

      try {
        const response = await fetch(`${API_URL}/transactions`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const json = await response.json()

        if (!response.ok) {
          if (response.status === 422) throw new Error(json.detail[0].msg)
          throw new Error("An error occurred.")
        }
        else {
          // Hide the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
          modal.hide();

          // Show toast
          bootstrap.showToast({body: 'Transaction added.', delay: 1000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-success"})

          // Refresh the grid
          getTransactions();
        }
      }
      catch (error) {
        bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
      }
    }

    async function submitTransactionEdit(event) {
      event.preventDefault();

      const formData = new FormData(event.target);
      const data = Object.fromEntries(formData.entries());
      data.tags = data.tags ? data.tags.split(',').map(tag => tag.trim()) : [];

      try {
        const response = await fetch(`${API_URL}/transactions/${selectedRow.id}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const json = await response.json()

        if (!response.ok) {
          if (response.status === 422) throw new Error(json.detail[0].msg)
          throw new Error("An error occurred.")
        }
        else {
          // Hide the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
          modal.hide();

          // Show toast
          bootstrap.showToast({body: 'Transaction edited.', delay: 1000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-success"})

          // Refresh the grid
          getTransactions();
        }
      }
      catch (error) {
        bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
      }
    }

    async function submitTransactionDelete(event) {
      event.preventDefault();

      try {
        const response = await fetch(`${API_URL}/transactions/${selectedRow.id}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }

        const json = await response.json()

        if (!response.ok) {
          if (response.status === 422) throw new Error(json.detail[0].msg)
          throw new Error("An error occurred.")
        }
        else {
          // Hide the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModalDelete'));
          modal.hide();

          // Show toast
          bootstrap.showToast({body: 'Transaction deleted.', delay: 1000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-success"})

          // Refresh the grid
          getTransactions();
        }
      }
      catch (error) {
        bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
      }
    }

    function toggleRecurring(enabled) {
      const recurringDiv = document.getElementById('recurringDiv');
      const date = document.getElementById('dateInput');
      const startDate = document.getElementById('startDateInput');
      const endDate = document.getElementById('endDateInput');
      const frequencySelect = document.getElementById('frequencySelect');

      if (enabled) {
        recurringDiv.style.display = 'block';
        date.disabled = true;
        startDate.value = new Date().toLocaleDateString("en-CA"); // YYYY-MM-DD (Local time)
        startDate.required = true;
        endDate.required = true;
        frequencySelect.required = true;
      } else {
        recurringDiv.style.display = 'none';
        date.disabled = false;
        startDate.required = false;
        endDate.required = false;
        frequencySelect.required = false;
      }
    }

    function updateDeleteButton() {
      const selectedRows = gridApi.getSelectedRows();
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const selectedCount = document.getElementById('selectedCount');
      const container = document.getElementById('actionButtonsContainer');
      
      if (selectedRows.length > 0) {
        deleteBtn.classList.add('d-flex');
        deleteBtn.style.display = '';
        selectedCount.textContent = selectedRows.length;
        container.classList.add('compact-buttons');
      } else {
        deleteBtn.classList.remove('d-flex');
        deleteBtn.style.display = 'none';
        container.classList.remove('compact-buttons');
      }
    }

    function deleteSelectedTransactions() {
      const selectedRows = gridApi.getSelectedRows();
      const count = selectedRows.length;
      
      document.getElementById('deleteMultipleCount').textContent = count;
      document.getElementById('deleteMultiplePlural').textContent = count === 1 ? '' : 's';
      
      const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('transactionModalDeleteMultiple'));
      modal.show();
    }

    async function submitTransactionDeleteMultiple(event) {
      event.preventDefault();

      const selectedRows = gridApi.getSelectedRows();
      const transactionIds = selectedRows.map(row => row.id);

      try {
        const deletePromises = transactionIds.map(id =>
          fetch(`${API_URL}/transactions/${id}`, {
            method: 'DELETE',
            credentials: 'include',
          })
        );

        const responses = await Promise.all(deletePromises);

        // Check if any request failed
        const failedResponse = responses.find(r => !r.ok);
        if (failedResponse) {
          if (failedResponse.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error("An error occurred while deleting transactions.");
        }

        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModalDeleteMultiple'));
        modal.hide();

        // Show toast
        const count = transactionIds.length;
        bootstrap.showToast({
          body: `${count} transaction${count === 1 ? '' : 's'} deleted.`,
          delay: 1000,
          position: "top-0 start-50 translate-middle-x",
          toastClass: "text-bg-success"
        });

        // Refresh the grid
        getTransactions();
      }
      catch (error) {
        bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
      }
    }

    // --------
    // - AUTH -
    // --------
    async function checkLogin() {
      const response = await fetch(`${API_URL}/login/check`, {
        method: 'GET',
        credentials: 'include',
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const enabled = await response.json()
      if (enabled) document.getElementById('logoutButton').style.display = 'block'
    }

    async function logout() {
      await fetch(`${API_URL}/logout`, { method: 'POST', credentials: 'include' });
      window.location.href = '/login';
    }
  </script>
</body>
</html>