<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bootstrap Website</title>
  <!-- Bootstrap CSS CDN -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <!-- AG Grid -->
  <script src="js/ag-grid-community.min.noStyle.js"></script>
  <link rel="stylesheet" href="css/tom-select.min.css">
  <link rel="stylesheet" href="css/tom-select.bootstrap5.min.css">
  <script src="js/tom-select.complete.min.js"></script>

  <style>
    .text-green {
      color: green;
    }

    .text-red {
      color: red;
    }

    .ag-cell {
      display: flex;
      align-items: center;
      height: 100%;
      line-height: 1.7;
      padding-top: 4px;
      padding-bottom: 4px;
      /* white-space: normal !important; */
    }

    .ag-header-cell-label {
      font-weight: 600;
    }

    .month-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .current-month {
      font-size: 1.6rem;
      font-weight: bold;
      min-width: 200px;
      text-align: center;
    }

    #prevMonth, #nextMonth {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 56px;           /* wider than height for oval */
      height: 40px;
      border-radius: 24px;   /* elliptical corners */
      cursor: pointer;
      color: black;
      position: relative;
      /* No border or background normally */
      border: 2px solid transparent;
      background-color: transparent;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    #prevMonth:hover, #nextMonth:hover {
      background-color: #cce4ff;  /* light blue bg on hover */
      border-color: #4a90e2;      /* blue border on hover */
      color: #004aad;             /* blue icon on hover */
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="bg-light py-3">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light">
        <a class="navbar-brand" href="#">Logo</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="#">About</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Contact <i class="fa-solid fa-pen-to-square"></i></a></li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container my-4">
    <div class="row">
      <!-- <div class="col-md-8">
        <h1>Welcome to My Website</h1>
        <p class="lead">This is a sample Bootstrap website template.</p>
      </div> -->

      <!-- Modal -->
      <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <form id="transactionForm" class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

              <!-- Name -->
              <div class="mb-3">
                <label for="nameInput" class="form-label">Name</label>
                <input type="text" class="form-control" id="nameInput" placeholder="Enter name" required />
              </div>

              <!-- Category -->
              <div class="mb-3">
                <label for="categorySelect" class="form-label">Category</label>
                <select class="form-select" id="categorySelect" required>
                  <option value="" selected disabled>Select category</option>
                  <option>Food</option>
                  <option>Transport</option>
                  <option>Entertainment</option>
                  <option>Utilities</option>
                  <option>Other</option>
                </select>
              </div>

              <!-- Tags -->
              <div class="mb-3">
                <label class="form-label">Tags</label>
                <input id="input-tags" type="text" class="form-control" value="awesome,neat" placeholder="Add a tag and press Enter" autocomplete="off">
              </div>

              <!-- Amount -->
              <div class="mb-3">
                <label for="amountInput" class="form-label">Amount</label>
                <input type="number" class="form-control" id="amountInput" min="0.01" step="0.01" required />
              </div>

              <!-- Type -->
              <div class="mb-3">
                <label for="typeSelect" class="form-label">Type</label>
                <select class="form-select" id="typeSelect" required>
                  <option>Expense</option>
                  <option>Income</option>
                </select>
              </div>

              <!-- Date -->
              <div class="mb-3">
                <label for="dateInput" class="form-label">Date</label>
                <input type="date" class="form-control" id="dateInput" required />
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Add Transaction</button>
            </div>
          </form>
        </div>
      </div>

      <div id="monthHeader" class="month-navigation">
        <div id="prevMonth" style="cursor: pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="24" height="24" fill="currentColor">
            <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 288 480 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-370.7 0 105.4-105.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/>
          </svg>
        </div>
        <div id="currentMonth" class="current-month"></div>
        <div id="nextMonth" style="cursor: pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="24" height="24" fill="currentColor">
            <path d="M502.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l370.7 0-105.4 105.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/>
          </svg>
        </div>
      </div>

      <div class="d-flex justify-content-center align-items-center mt-1 mb-4">
        <button type="button" class="btn btn-outline-success w-auto" style="font-size: 0.9rem; margin-right:5px;" data-bs-toggle="modal" data-bs-target="#transactionModal">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor" style="margin-right: 2px; padding-bottom: 2px">
            <path d="M256 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 160-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0 0-160z"/>
          </svg>
          Add Transaction
        </button>
        <div class="d-flex justify-content-center">
          <label class="btn btn-outline-primary d-flex align-items-center gap-2" style="user-select:none; cursor:pointer; font-size: 0.9rem; margin-left:5px">
            <input id="showAllTransactions" type="checkbox" class="form-check-input" style="margin-top: 0; margin-bottom: 0; vertical-align: middle;" onchange="showTransactions()" />
            Show All
          </label>
        </div>
      </div>

      <!-- Grid Filter -->
      <div class="mb-2">
        <input type="text" class="form-control" id="nameInput" placeholder="Search..."  oninput="onFilterTextBoxChanged()" />
      </div>

      <!-- Your Data Grid container -->
      <div id="myGrid" style="height: 500px"></div>
      <div id="rowCount" class="mt-3" style="text-align: center; font-size: 0.9rem; font-weight: 600;"></div>
    </div>
  </main>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="js/bootstrap.min.js"></script>
  
  <script>
    let settings;
    let gridInstance;
    let gridApi;
    let theme = 'light';
    let currentDate = new Date();
    const currentMonthElement = document.getElementById('currentMonth');
    
    async function main() {
      // Initialize display
      renderMonth();
      // Initialize the grid with settings
      settings = await getSettings();
      gridApi = await initGrid();
    }

    async function getCurrentMonth() {
      const date = new Date();
      const options = { month: 'long', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    async function getCurrentMonthInfo() {
      const date = new Date();

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const monthName = date.toLocaleString('en-US', { month: 'long' });

      return {
        year,
        month,
        monthName,
      };
    }

    async function getSettings() {
      const response = await fetch('http://localhost:8000/settings');
      const data = await response.json();
      return data;
    }

    async function initGrid() {
      let myTheme;

      if (gridInstance) {
        gridInstance.destroy();
      }

      if (theme === 'dark') {
        myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeDark);
      }
      else {
        myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeLightWarm);
      }

      // Grid Options: Contains all of the Data Grid configurations
      // let myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeDark);
      // const myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeDarkBlue);
      // const myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeLightWarm);
      // const myTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeLightCold);
      const gridOptions = {
        theme: myTheme,
        suppressMovableColumns: true,
        rowData: [],
        defaultColDef: {
          flex: 1,
          minWidth: 150,
        },
        onGridReady: params => {
          gridApi = params.api;
          showTransactions();
        },
        onFilterChanged: params => {
          updateRowCount(params.api);
        },
        columnDefs: [
          {
            field: "name",
            wrapText: true,   // allows line wrapping
            autoHeight: true,  // row height adjusts to fit
            cellRenderer: (params) => {
              const container = document.createElement('span');
  
              if (params.data?.recurringID) {
                // SVG icon
                container.innerHTML = `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="10" height="10" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M488 192l-144 0c-9.7 0-18.5-5.8-22.2-14.8s-1.7-19.3 5.2-26.2l46.7-46.7c-75.3-58.6-184.3-53.3-253.5 15.9-75 75-75 196.5 0 271.5s196.5 75 271.5 0c8.2-8.2 15.5-16.9 21.9-26.1 10.1-14.5 30.1-18 44.6-7.9s18 30.1 7.9 44.6c-8.5 12.2-18.2 23.8-29.1 34.7-100 100-262.1 100-362 0S-25 175 75 75c94.3-94.3 243.7-99.6 344.3-16.2L471 7c6.9-6.9 17.2-8.9 26.2-5.2S512 14.3 512 24l0 144c0 13.3-10.7 24-24 24z"/>
                  </svg>
                `;
                // Add the name text after the SVG
                const nameSpan = document.createElement('span');
                nameSpan.textContent = params.data?.name;
                container.appendChild(nameSpan);
              } else {
                // Just the name if no recurringID
                container.textContent = params.data?.name;
              }
              return container;
            }
          },
          { field: "category" },
          {
            field: "tags",
            valueFormatter: (params) => {
              return params.value ? params.value.join(", ") : "";
            },
          },
          {
            field: "amount",
            valueFormatter: (params) => {
              const amount = params.value;
              const type = params.data?.type;
              const currency = settings.currency;
              const prefixSign = type === 'expense' ? '-' : '';

              // Currencies with symbol on left
              const leftCurrencies = ['usd', 'gbp', 'jpy', 'cny', 'krw', 'inr'];

              if (leftCurrencies.includes(currency)) {
                // symbol on left
                const symbolMap = {
                  usd: '$',
                  gbp: '£',
                  jpy: '¥',
                  cny: '¥',
                  krw: '₩',
                  inr: '₹',
                };
                const symbol = symbolMap[currency] || '';
                return `${prefixSign}${symbol}${amount}`;
              } else {
                // symbol on right (e.g. euro)
                const symbolMap = {
                  eur: '€',
                };
                const symbol = symbolMap[currency] || '';
                return `${prefixSign}${amount} ${symbol}`;
              }
            },
            cellClass: (params) => {
              if (params.data?.type === 'income') return 'text-green';
              if (params.data?.type === 'expense') return 'text-red';
            },
            comparator: (valueA, valueB, nodeA, nodeB, isInverted) => {             
              const aData = nodeA.data;
              const bData = nodeB.data;
              
              // Calculate "sort value" for aData.amount based on type
              const aVal = (aData.type === 'expense' ? -aData.amount : aData.amount);
              const bVal = (bData.type === 'expense' ? -bData.amount : bData.amount);

              // Normal numeric compare
              if (aVal < bVal) return -1;
              if (aVal > bVal) return 1;
              return 0;
            }
          },
          { field: "date" },
          { 
            field: "actions",
            width: 100,
            cellRenderer: (params) => {
              const container = document.createElement("div");
              container.style.display = "flex";
              container.style.alignItems = "center";

              // Edit button
              const editButton = document.createElement("span");
              editButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16.5" height="16.5" fill="currentColor" style="display: inline-block; vertical-align: middle;">
                  <path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L368 46.1 465.9 144 490.3 119.6c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L432 177.9 334.1 80 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z"/>
                </svg>
              `;
              editButton.style.display = "flex";
              editButton.style.justifyContent = "center";
              editButton.style.alignItems = "center";
              editButton.style.width = "35px";
              editButton.style.height = "35px";
              editButton.style.borderRadius = "50%";
              editButton.style.cursor = "pointer";
              editButton.style.marginRight = "1px";
              editButton.style.color = "black";
              editButton.style.transition = "color 0.3s ease, background-color 0.3s ease";
              editButton.style.backgroundColor = "transparent";
              editButton.style.lineHeight = "0";
              editButton.style.filter = "opacity(0.8)";
              editButton.title = "Edit Transaction";

              editButton.addEventListener("mouseenter", () => {
                editButton.style.color = "blue";
                editButton.style.backgroundColor = "#cce4ff";
              });
              editButton.addEventListener("mouseleave", () => {
                editButton.style.color = "black";
                editButton.style.backgroundColor = "transparent";
              });
              editButton.addEventListener("click", () => {
                console.log("Edit clicked for", params.data);
              });

              // Delete button
              const deleteButton = document.createElement("span");
              deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor" style="display: inline-block; vertical-align: middle;">
                  <path d="M136.7 5.9C141.1-7.2 153.3-16 167.1-16l113.9 0c13.8 0 26 8.8 30.4 21.9L320 32 416 32c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 96C14.3 96 0 81.7 0 64S14.3 32 32 32l96 0 8.7-26.1zM32 144l384 0 0 304c0 35.3-28.7 64-64 64L96 512c-35.3 0-64-28.7-64-64l0-304zm88 64c-13.3 0-24 10.7-24 24l0 192c0 13.3 10.7 24 24 24s24-10.7 24-24l0-192c0-13.3-10.7-24-24-24zm104 0c-13.3 0-24 10.7-24 24l0 192c0 13.3 10.7 24 24 24s24-10.7 24-24l0-192c0-13.3-10.7-24-24-24zm104 0c-13.3 0-24 10.7-24 24l0 192c0 13.3 10.7 24 24 24s24-10.7 24-24l0-192c0-13.3-10.7-24-24-24z"/>
                </svg>
              `;
              deleteButton.style.display = "flex";
              deleteButton.style.justifyContent = "center";
              deleteButton.style.alignItems = "center";
              deleteButton.style.width = "35px";
              deleteButton.style.height = "35px";
              deleteButton.style.borderRadius = "50%";
              deleteButton.style.cursor = "pointer";
              deleteButton.style.marginLeft = "1px";
              deleteButton.style.color = "black";
              deleteButton.style.transition = "color 0.3s ease, background-color 0.3s ease";
              deleteButton.style.backgroundColor = "transparent";
              deleteButton.style.lineHeight = "0";
              deleteButton.style.filter = "opacity(0.8)";
              deleteButton.title = "Delete Transaction";

              deleteButton.addEventListener("mouseenter", () => {
                deleteButton.style.color = "red";
                deleteButton.style.backgroundColor = "#ffc9c9";
              });
              deleteButton.addEventListener("mouseleave", () => {
                deleteButton.style.color = "black";
                deleteButton.style.backgroundColor = "transparent";
              });
              deleteButton.addEventListener("click", () => {
                console.log("Delete clicked for", params.data);
                // Example: remove from grid
                // params.api.applyTransaction({ remove: [params.data] });
              });

              container.appendChild(editButton);
              container.appendChild(deleteButton);

              return container;
            }
          }
        ]
      }

      // Your Javascript code to create the Data Grid
      const myGridElement = document.querySelector('#myGrid');
      gridInstance = agGrid.createGrid(myGridElement, gridOptions);
    }

    function renderMonth() {
      currentMonthElement.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    function onFilterTextBoxChanged() {
      gridApi.setGridOption(
        "quickFilterText",
        document.getElementById("filter-text-box").value,
      );
    }

    async function showTransactions() {
      const showAll = document.getElementById('showAllTransactions').checked;
      const monthHeader = document.getElementById('monthHeader');
      if (showAll) {
        monthHeader.style.display = 'none';
        // Fetch all transactions
        await fetch('http://localhost:8000/transactions')
          .then(response => response.json())
          .then(data => gridApi.setGridOption('rowData', data));
      } else {
        monthHeader.style.display = 'flex';
        // Fetch only current month transactions
        const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // "01" to "12"
        const year = currentDate.getFullYear(); // 2025
        await fetch(`http://localhost:8000/transactions/date/${year}-${month}`)
          .then(response => response.json())
          .then(data => gridApi.setGridOption('rowData', data));
      }
      updateRowCount(gridApi);
    }

    // Prev month button
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderMonth();
      showTransactions();
    });

    // Next month button
    document.getElementById('nextMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderMonth();
      showTransactions();
    });

    function updateRowCount(api) {
      const rowCount = api.getDisplayedRowCount();
      document.getElementById('rowCount').innerText = `Rows shown: ${rowCount}`;
    }

    // Execute the main function to initialize the grid
    main();
  </script>

  <script>
    new TomSelect('#input-tags', {
      plugins: {
        remove_button: {
          title: 'Remove this tag',
        }
      },
      persist: false,
      create: true,
    });
  </script>

  <script>
    const dateInput = document.getElementById('dateInput');
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    dateInput.value = today;
  </script>
</body>
</html>