<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wally | Dashboards</title>
  <link rel="icon" type="image/png" href="assets/wally.png">
  <meta name="robots" content="index,follow" />
  <meta name="description" content="A lightweight, self-hosted expense tracker to easily manage your finances." />
  <meta property="author" content="Pol Alzina" />
  <meta property="og:title" content="Wally" />
  <meta property="og:description" content="A lightweight, self-hosted expense tracker to easily manage your finances." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="assets/wally.png" />
  <!-- CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/tom-select.min.css" rel="stylesheet">
  <link href="css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <!-- JS -->
  <script src="js/bootstrap.bundle.min.js" defer></script>
  <script src="js/bootstrap-show-toast.js" defer></script>
  <script src="js/ag-grid-community.min.noStyle.js" defer></script>
  <script src="js/tom-select.complete.min.js" defer></script>
  <script src="js/chart.umd.min.js" defer></script>
  <script src="js/decimal.min.js" defer></script>

  <script>
    (function() {
      const theme = localStorage.getItem('theme') || 'system';
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (theme === 'light' || (theme === 'system' && !systemPrefersDark)) {
        document.documentElement.setAttribute('data-bs-theme', 'light');
      }
      else {
        document.documentElement.setAttribute('data-bs-theme', 'dark');
      }
    })();
  </script>

  <style>
    :root[data-bs-theme="light"] {
      --header-bg: #f8f8f8;
      --pill-bg: #f4f4f7;
      --pill-color: #000;
      --amount-color: var(--bs-gray-800);
    }
    :root[data-bs-theme="dark"] {
      --header-bg: #262a2e;
      --pill-bg: #282c30;
      --pill-color: #FFF;
      --amount-color: var(--bs-gray-500);
    }
    header {
      background-color: var(--header-bg);
    }

    input, .option {
      color: var(--pill-color)!important;
    }

    .ts-control .item {
      background-color: var(--pill-bg)!important;
      color: var(--pill-color)!important;
    }

    .ts-control .item .remove {
      border-color: var(--header-bg)!important;
    }

    #tagsInput-ts-dropdown .create, #tagsInput-ts-dropdown .no-results {
      color: var(--pill-color)!important;
    }

    .form-check-input {
      background-color: white;
    }

    .month-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .current-month {
      font-size: 1.6rem;
      font-weight: bold;
      min-width: 200px;
      text-align: center;
    }

    #prevMonth, #nextMonth {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 40px;
      border-radius: 24px;
      cursor: pointer;
      color: var(--pill-color);
      position: relative;
      /* No border or background */
      border: 2px solid transparent;
      background-color: transparent;
      transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    #prevMonth:hover, #nextMonth:hover {
      background-color: #cce4ff;
      border-color: #4a90e2;
      color: #004aad;
    }

    main.container {
      padding-top: 1rem;
      padding-bottom: 1rem;
    }

    /* Chart styles */
    .chart-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      background-color: var(--header-bg);
      border-radius: 8px;
      min-height: 450px;
      align-items: center;
    }

    .chart-box {
      height: 380px;
      margin-left: auto;
      margin-right: auto;
    }

    .chart-box canvas {
      max-height: 380px;
    }

    .legend-box {
      flex: 1;
      padding: 1rem 2rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .legend-text {
      display: flex;
      justify-content: space-between;
      flex: 1;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      cursor: pointer;
      user-select: none;
    }

    .legend-item.disabled .color-box {
      background-color: #808080 !important;
      position: relative;
    }

    .legend-item.disabled .color-box::after {
      content: 'Ã—';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-primary);
      font-weight: bold;
    }

    .legend-item.disabled .legend-text {
      opacity: 0.5;
    }

    .color-box {
      width: 16px;
      height: 16px;
      margin-right: 1rem;
      border-radius: 3px;
      transition: background-color 0.3s ease;
    }

    .amount {
      font-family: monospace;
      color: var(--amount-color);
      font-size: 0.85rem;
    }

    .no-data {
      text-align: center;
      font-style: italic;
      padding: 2rem;
    }

    /* Cashflow styles */
    .cashflow-container {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: stretch;
    }

    .cashflow-item {
      flex: 1;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .cashflow-item.income {
      background-color: rgba(52, 211, 153, 0.1);
    }

    .cashflow-item.expenses {
      background-color: rgba(239, 68, 68, 0.1);
    }

    .cashflow-item.balance {
      background-color: rgba(251, 191, 36, 0.1);
    }

    .cashflow-label {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .cashflow-value {
      font-size: 1.4rem;
      font-weight: bold;
    }

    .cashflow-value.positive {
      color: #2EAB7D;
    }

    .cashflow-value.negative {
      color: #EF4444;
    }

    @media (max-width: 768px) {
      .chart-container {
        flex-direction: column;
        min-height: auto;
        padding: 1rem;
        padding-top: 0;
      }

      .chart-box {
        max-height: 250px;
        margin-top: 20px;
      }

      .chart-box canvas {
        max-height: 300px;
      }

      .legend-box {
        width: 100%;
        padding: 0.5rem;
        padding-top: 1rem;
      }

      .legend-item {
        margin-bottom: 0.5rem;
      }

      .month-navigation {
        gap: 0.2rem;
        margin-bottom: 0.75rem;
      }

      .container {
        padding: 0.5rem;
      }

      .chart-container {
        margin-bottom: 0.5rem;
        gap: 0.5rem;
      }

      .cashflow-container {
        margin-bottom: 0.5rem;
        gap: 0.5rem;
        flex-direction: row;
        justify-content: space-around;
      }
      
      .cashflow-item {
        padding: 0.5rem;
      }
      
      .cashflow-value {
        font-size: 1rem;
      }

      .cashflow-label {
        margin-bottom: 0.25rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light">
        <a class="navbar-brand d-flex align-items-center" style="margin-left:10px; margin-right:30px" href="/">
          <img src="assets/wally.png" alt="Wally" width="50" height="50" style="margin-bottom: 5px; margin-right: 8px;">
          <span style="font-size: 1.8rem; font-weight:600;">Wally</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item" style="margin-left: 10px"><a class="nav-link active" href="/" style="font-weight: 500">Dashboards</a></li>
            <li class="nav-item" style="margin-left: 10px"><a class="nav-link" href="transactions">Transactions</a></li>
            <li class="nav-item" style="margin-left: 10px"><a class="nav-link" href="settings">Settings</a></li>
          </ul>
          <ul id="logoutButton" class="navbar-nav ms-auto" style="display: none;">
            <li class="nav-item nav-link" style="margin-left: 10px; cursor: pointer;" title="Logout" onclick="logout()">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--pill-color)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2" />
                <path d="M9 12h12l-3 -3" />
                <path d="M18 15l3 -3" />
              </svg>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container my-2">

    <!-- Month Header -->
    <div id="monthHeader" class="month-navigation">
      <div id="prevMonth" style="cursor: pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="22" height="22" fill="currentColor">
          <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 288 480 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-370.7 0 105.4-105.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/>
        </svg>
      </div>
      <div id="currentMonth" class="current-month"></div>
      <div id="nextMonth" style="cursor: pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="22" height="22" fill="currentColor">
          <path d="M502.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l370.7 0-105.4 105.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/>
        </svg>
      </div>
    </div>
    <div id="monthHeaderAll" class="month-navigation current-month" style="display: none; height: 40px"></div>

    <!-- Action buttons -->
    <div class="d-flex justify-content-center align-items-center mb-4" style="margin-top: 25px">
      <button type="button" class="btn btn-success" style="font-size: 0.9rem; margin-right:5px; width: 150px; height:40px; border-radius: 100px" data-bs-toggle="modal" data-bs-target="#transactionModal" onclick="addTransaction()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor" style="margin-right: 2px; padding-bottom: 2px">
          <path d="M256 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 160-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0 0 160c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0 0-160z"/>
        </svg>
        Add
      </button>
      <button type="button" class="btn btn-primary" style="font-size: 0.9rem; margin-left:5px; width: 150px; height:40px; border-radius: 100px" data-bs-toggle="modal" data-bs-target="#dashboardModal">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="currentColor" style="margin-right: 2px; padding-bottom: 2px">
          <path d="M64 64c0-17.7-14.3-32-32-32S0 46.3 0 64L0 400c0 44.2 35.8 80 80 80l400 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 416c-8.8 0-16-7.2-16-16L64 64zm406.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L320 210.7 262.6 153.4c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l73.4-73.4 57.4 57.4c12.5 12.5 32.8 12.5 45.3 0l128-128z"/>
        </svg>
        Change
      </button>
    </div>

    <!-- Chart & Legend Box -->
    <div class="row chart-container">
      <div id="noDataMessage" class="no-data" style="display: none; width: 100%;">There are no expenses.</div>
      <div class="col-lg-6 chart-box">
        <canvas id="chartCanvas"></canvas>
      </div>
      <div id="customLegend" class="col-lg-6 legend-box"></div>
    </div>

    <!-- Cashflow Section -->
    <div id="cashflow-section" class="cashflow-container" style="display: none">
      <div class="cashflow-item income">
        <div class="cashflow-label">Income</div>
        <div class="cashflow-value" id="cashflow-income"></div>
      </div>
      <div class="cashflow-item expenses">
        <div class="cashflow-label">Expenses</div>
        <div class="cashflow-value" id="cashflow-expenses"></div>
      </div>
      <div class="cashflow-item balance">
        <div class="cashflow-label">Balance</div>
        <div class="cashflow-value" id="cashflow-balance"></div>
      </div>
    </div>

    <!-- Dashboard Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1" aria-labelledby="dashboardModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <form id="dashboardForm" class="modal-content" onsubmit="submitDashboard(event)">
          <div class="modal-header">
            <h5 class="modal-title" id="dashboardModalLabel">Change Dashboard</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Select a dashboard to view:</p>
            <div class="form-check mb-1">
              <input class="form-check-input" type="radio" name="range" value="oneMonth" id="oneMonthRadio" checked>
              <label class="form-check-label" for="oneMonthRadio">
                One Month
              </label>
            </div>
            <div class="form-check mb-1">
              <input class="form-check-input" type="radio" name="range" value="lastYear" id="lastYearRadio">
              <label class="form-check-label" for="lastYearRadio">
                Last 12 Months
              </label>
            </div>
            <div class="form-check mb-1">
              <input class="form-check-input" type="radio" name="range" value="yearToDate" id="yearToDateRadio">
              <label class="form-check-label" for="yearToDateRadio">
                Year to Date
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="range" value="allData" id="allDataRadio">
              <label class="form-check-label" for="allDataRadio">
                All Data
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width: 120px">Cancel</button>
            <button type="submit" class="btn btn-primary" id="dashboardModalSubmitButton" style="width: 120px">Change</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Transaction Modal (Add and Edit) -->
  <div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="transactionForm" class="modal-content" onsubmit="submitTransaction(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <!-- Name -->
          <div class="mb-3">
            <label for="nameInput" class="form-label">Name</label>
            <input type="text" class="form-control" id="nameInput" name="name" placeholder="Enter name" required />
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label for="categorySelect" class="form-label">Category</label>
            <select class="form-select" id="categorySelect" name="category" required></select>
          </div>

          <!-- Tags -->
          <div class="mb-3">
            <label class="form-label">Tags</label>
            <input id="tagsInput" name="tags" type="text" class="form-control" value="" placeholder="Add a tag and press Enter" autocomplete="off">
          </div>

          <!-- Amount -->
          <div class="mb-3">
            <label for="amountInput" class="form-label">Amount</label>
            <input type="text" inputmode="decimal" class="form-control" id="amountInput" name="amount" min="0.01" step="0.01" required />
          </div>

          <!-- Type -->
          <div class="mb-3">
            <label for="typeSelect" class="form-label">Type</label>
            <select class="form-select" id="typeSelect" name="type" required>
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>

          <!-- Date -->
          <div>
            <label for="dateInput" class="form-label">Date</label>
            <input type="date" class="form-control" id="dateInput" name="date" required />
          </div>

          <!-- Recurring -->
          <div id="recurringElement" class="form-check mt-3">
            <input class="form-check-input" type="checkbox" value="" id="recurringCheck" name="recurringCheck" onchange="toggleRecurring(event.target.checked)" />
            <label class="form-check-label" for="recurringCheck">
              Recurring
            </label>
          </div>

          <div id="recurringDiv" class="card mt-3" style="display: none;">
            <div class="card-body">
              <div class="row">
                <!-- Start Date -->
                <div class="col-6 mb-3">
                  <label for="startDateInput" class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="startDateInput" name="startDate" />
                </div>
                <!-- End Date -->
                <div class="col-6 mb-3">
                  <label for="endDateInput" class="form-label">End Date</label>
                  <input type="date" class="form-control" id="endDateInput" name="endDate" />
                </div>
              </div>

              <!-- Frequency -->
              <div>
                <label for="frequencySelect" class="form-label">Frequency</label>
                <select class="form-select" id="frequencySelect" name="frequency">
                  <option value="" disabled selected>Select frequency</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width: 120px">Cancel</button>
          <button type="submit" class="btn btn-success" id="modalSubmitButton" style="width: 120px">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction Modal Delete -->
  <div class="modal fade" id="transactionModalDelete" tabindex="-1" aria-labelledby="transactionModalDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" onsubmit="submitTransaction(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="transactionModalDeleteLabel">Delete Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this transaction?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="width: 120px">Cancel</button>
          <button type="submit" class="btn btn-danger" style="width: 120px">Delete</button>
        </div>
      </form>
    </div>
  </div>
</body>
<script>
  const API_URL = '/api'; // 'http://127.0.0.1:8000';

  let currentDate = new Date();
  let categories;
  let tags;
  let currency;

  let chart;
  let chartSelected = "oneMonth";
  let chartDisabledFields = new Set();

  let tagsInput;

  // Execute the main function when DOM has loaded
  document.addEventListener('DOMContentLoaded', () => main());
  
  async function main() {
    await checkLogin();

    document.getElementById('dashboardForm').reset();
    [categories, tags, currency] = await Promise.all([
      getCategories(),
      getTags(),
      getCurrency(),
      renderMonth(),
    ]);

    // Load chart
    await loadChart();

    // Render categories and tags
    await renderCategories();
    await renderTags();
  }

  async function getCategories() {
    const response = await fetch(`${API_URL}/categories`, {
      method: 'GET',
      credentials: 'include',
    });

    if (response.status === 401) {
      window.location.href = '/login';
      return;
    }

    const data = await response.json();
    return data;
  }

  async function getTags() {
    const response = await fetch(`${API_URL}/tags`, {
      method: 'GET',
      credentials: 'include',
    });

    if (response.status === 401) {
      window.location.href = '/login';
      return;
    }

    const data = await response.json();
    return data;
  }

  async function getCurrency() {
    const response = await fetch(`${API_URL}/currency`, {
      method: 'GET',
      credentials: 'include',
    });

    if (response.status === 401) {
      window.location.href = '/login';
      return;
    }

    const data = await response.json();
    return data.filter(x => x.selected)[0];
  }

  async function getTransactions() {
    let endpoint;
    if (chartSelected == 'oneMonth') {
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const year = currentDate.getFullYear();
      endpoint = `${API_URL}/transactions/date/${year}-${month}`;
    }
    else if (chartSelected == 'lastYear') {
      endpoint = `${API_URL}/transactions/past-year`;
    }
    else if (chartSelected == 'yearToDate') {
      endpoint = `${API_URL}/transactions/year-to-date`;
    }
    else if (chartSelected == 'allData') {
      endpoint = `${API_URL}/transactions`;
    }

    try {
      const response = await fetch(endpoint, {
        method: 'GET',
        credentials: 'include',
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const json = await response.json()

      if (!response.ok) throw new Error("An error occurred.")
      return json;
    }
    catch (error) {
      bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
    }
  }

  function renderMonth() {
    document.getElementById('currentMonth').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  }

  // Prev month button
  document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderMonth();
    loadChart();
  });

  // Next month button
  document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderMonth();
    loadChart();
  });

  async function loadChart() {
    const transactions = await getTransactions();
    const chartBox = document.querySelector('.chart-box');
    const legendBox = document.getElementById('customLegend');
    const cashflowSection = document.getElementById('cashflow-section');
    const noDataMessage = document.getElementById('noDataMessage');
    const hasExpenses = transactions.some(t => t.type === 'expense');

    if (!hasExpenses) {
      chartBox.style.display = 'none';
      legendBox.style.display = 'none';
      cashflowSection.style.display = 'none';
      noDataMessage.style.display = 'block';
    }
    else {
      chartBox.style.display = 'flex';
      legendBox.style.display = 'flex';
      cashflowSection.style.display = 'flex';
      noDataMessage.style.display = 'none';
      
      const data = calculateBreakdown(transactions);
      updateChart(data);
      updateLegend(transactions, data);
      updateCashflow(transactions);
    }
  }

  function updateCashflow(transactions) {
    const income = transactions.filter(t => t.type === 'income').reduce((acc, t) => Decimal.add(acc, t.amount).toNumber(), 0);
    const expense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => Decimal.add(acc, t.amount).toNumber(), 0);
    const balance = Decimal.sub(income, expense);

    document.getElementById('cashflow-income').textContent = formatCurrency(income);
    document.getElementById('cashflow-expenses').textContent = formatCurrency(expense);
    document.getElementById('cashflow-balance').textContent = formatCurrency(balance);

    const balanceElement = document.getElementById('cashflow-balance');
    if (balance >= 0) {
      balanceElement.classList.add('positive');
      balanceElement.classList.remove('negative');
    } else {
      balanceElement.classList.add('negative');
      balanceElement.classList.remove('positive');
    }
  }

  function updateChart(data) {
    if (chart) chart.destroy();

    if (chartSelected == 'oneMonth') {
      chart = new Chart('chartCanvas', {
        type: 'doughnut',
        data: {
          labels: data.map(x => x.name),
          datasets: [{
            data: data.map(x => x.total),
            borderColor: '#1a1a1a',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            colors: {
              forceOverride: true
            },
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((sum, val) => Decimal.add(sum, val).toNumber(), 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    else {
      // Compute labels based on the selected range
      let range;
      if (chartSelected === 'lastYear') range = getLast12Months();
      else if (chartSelected === 'yearToDate') range = getYearToDate();
      else if (chartSelected === 'allData') range = getAllMonths(data);

      chart = new Chart('chartCanvas', {
        type: 'line',
        data: {
          labels: range.map(x => formatDate(x)),
          datasets: data.map(item => ({
            label: item.name,
            data: range.map(m => {
              const idx = item.dates.indexOf(m);
              return idx !== -1 ? item.amounts[idx] : 0;
            }),
            fill: false,
            borderColor: '#1a1a1a',
            tension: 0.1,
          })),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            colors: {
              forceOverride: true
            },
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw;
                  const total = context.dataset.data.reduce((sum, val) => Decimal.add(sum, val).toNumber(), 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `${context.dataset.label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
  }

  function calculateBreakdown(transactions) {
    const breakdownMap = {};

    for (const { type, amount, date, ...rest } of transactions) {
      const groupValue = rest.category;

      if (type === 'expense' && !chartDisabledFields.has(groupValue)) {
        if (!breakdownMap[groupValue]) {
          breakdownMap[groupValue] = { total: 0, months: {} };
        }

        const monthKey = date.slice(0, 7); // YYYY-MM
        breakdownMap[groupValue].total = Decimal.add(breakdownMap[groupValue].total, amount).toNumber();
        breakdownMap[groupValue].months[monthKey] = Decimal.add((breakdownMap[groupValue].months[monthKey] || 0), amount).toNumber();
      }
    }

    const result = Object.entries(breakdownMap)
      .map(([name, { total, months }]) => {
        const sortedMonths = Object.keys(months).sort();
        return {
          name,
          total,
          dates: sortedMonths,
          amounts: sortedMonths.map(m => months[m])
        };
      })
      .sort((a, b) => b.total - a.total);

    const grandTotal = result.reduce((sum, item) => Decimal.add(sum, item.total).toNumber(), 0);

    // Add percentage field
    return result.map(item => ({
      ...item,
      percentage: grandTotal ? (item.total / grandTotal) * 100 : 0
    }));
  }

  function updateLegend(transactions, data) {
    const legendContainer = document.getElementById('customLegend');
    legendContainer.innerHTML = '';

    const monthExpenses = transactions.filter(t => t.type === 'expense');
    const labelMap = new Map(data.map(x => [x.name, x]));

    monthExpenses
      .map(exp => exp.category)
      .filter((v, i, a) => a.indexOf(v) === i) // Remove duplicates
      .sort((a, b) => {
        const da = labelMap.get(a), db = labelMap.get(b);
        if (da && db) return db.total - da.total;
        if (da) return -1;
        if (db) return 1;
        return a.localeCompare(b);
      })
      .forEach(label => {
        const categoryData = labelMap.get(label);
        const color = chartSelected === 'oneMonth'
          ? chart.data.datasets[0].backgroundColor[chart.data.labels.indexOf(label)]
          :  chart.data.datasets.find(x => x.label === label)?.backgroundColor;
        const percentage = categoryData ? ` (${categoryData.percentage.toFixed(1)}%)` : '';
        const amount = categoryData ? formatCurrency(categoryData.total) : '';

        const item = document.createElement('div');
        item.className = `legend-item${chartDisabledFields.has(label) ? ' disabled' : ''}`;
        item.innerHTML = `
          <div class="color-box" style="background-color: ${color}"></div>
          <div class="legend-text">
            <span>${label}${percentage}</span>
            <span class="amount">${amount}</span>
          </div>
        `;
        item.addEventListener('click', () => toggleLegend(label));
        legendContainer.appendChild(item);
      });

    const activeTotal = monthExpenses
      .filter(x => !chartDisabledFields.has(x.category))
      .reduce((sum, x) => Decimal.add(sum, x.amount).toNumber(), 0);

    legendContainer.insertAdjacentHTML('beforeend', `
      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--bs-border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>Total:</span>
          <span class="amount">${formatCurrency(activeTotal)}</span>
        </div>
      </div>
    `);
  }

  function formatCurrency(amount) {  
    if (currency.position === 'left') {
      if (Decimal(amount) < 0) return `-${currency.symbol}${Decimal(amount).abs()}`;
      else return `${currency.symbol}${amount}`;
    }
    else return `${amount} ${currency.symbol}`;
  }

  function toggleLegend(label) {
    if (chartDisabledFields.has(label)) chartDisabledFields.delete(label);
    else chartDisabledFields.add(label);
    loadChart();
  }

  function submitDashboard(event) {
    event.preventDefault();

    // Get form data
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());

    // Store the selected range and group in the global variable
    chartSelected = data.range;

    // Update header
    const monthHeader = document.getElementById('monthHeader');
    const monthHeaderAll = document.getElementById('monthHeaderAll');
    if (chartSelected == 'oneMonth') {
      monthHeader.style.display = 'flex';
      monthHeaderAll.style.display = 'none';
    }
    else {
      monthHeader.style.display = 'none';
      monthHeaderAll.style.display = 'flex';
      const mapRange = {
        "lastYear": "Last 12 Months",
        "yearToDate": "Year to Date",
        "allData": "All Data"
      }
      monthHeaderAll.innerText = mapRange[chartSelected]
    }

    // Load the chart with the new selection
    chartDisabledFields = new Set();
    loadChart();

    // Hide the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardModal'));
    modal.hide();
  }

  function getLast12Months() {
    // Generate previous 12 months including current month
    const months = [];
    const today = new Date();
    
    for (let i = 11; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const month = String(d.getMonth() + 1).padStart(2, '0');
      months.push(`${d.getFullYear()}-${month}`);
    }

    return months
  }

  function getYearToDate() {
    const months = [];
    const today = new Date();
    const year = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-indexed

    for (let m = 0; m <= currentMonth; m++) {
      const month = String(m + 1).padStart(2, '0');
      months.push(`${year}-${month}`);
    }
    return months;
  }

  function getAllMonths(data) {
    let minDate = null;
    let maxDate = null;

    data.forEach(item => {
      item.dates.forEach(d => {
        const [year, month] = d.split('-').map(Number);
        const date = new Date(year, month - 1);
        if (!minDate || date < minDate) minDate = date;
        if (!maxDate || date > maxDate) maxDate = date;
      });
    });

    const result = [];
    let current = new Date(minDate.getTime());

    while (current <= maxDate) {
      const monthStr = current.getMonth() + 1; // 1-12
      const yearStr = current.getFullYear();
      result.push(`${yearStr}-${monthStr.toString().padStart(2, '0')}`);
      current.setMonth(current.getMonth() + 1);
    }
    return result;
  }

  function alignData(dateArrays, amountArrays, refMonths) {
    return refMonths.map(m => {
      const idx = dateArrays.indexOf(m);
      return idx !== -1 ? amountArrays[idx] : 0;
    });
  }

  function formatDate(yyyymm) {
    const [year, month] = yyyymm.split('-').map(Number);
    const date = new Date(year, month - 1);
    return date.toLocaleString('en-US', { month: 'short', year: 'numeric' });
  }

  // ----------------
  // - Transactions -
  // ----------------
  document.getElementById('transactionModal').addEventListener('shown.bs.modal', () => {
    document.getElementById('nameInput').focus()
  });

  document.getElementById('amountInput').addEventListener('input', (event) => {
    if (event.target.value.includes(',')) {
      event.target.value = event.target.value.replace(',', '.');
    }
  });

  async function renderTags() {
    tagsInput = new TomSelect('#tagsInput', {
      plugins: {
        remove_button: {
          title: 'Remove this tag',
        }
      },
      persist: false,
      create: true,
      render: {
        no_results: function(data, escape) {
          return '';
        },
      }
    });

    tags.forEach(tag => {
      tagsInput.addOption({ value: tag, text: tag }, user_created=false);
    });
  }

  async function renderCategories() {
    const select = document.getElementById('categorySelect');

    // Clear any existing options
    select.innerHTML = "";

    // First static placeholder option
    const placeholder = document.createElement('option');
    placeholder.value = "";
    placeholder.textContent = "Select category";
    placeholder.selected = true;
    placeholder.disabled = true;
    select.appendChild(placeholder);

    // Then your dynamic options
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      option.selected = false;
      select.appendChild(option);
    });
  }

  function addTransaction() {
    document.getElementById('transactionForm').reset();
    document.getElementById('categorySelect').value = "";
    tagsInput.setValue([]);
    document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
    document.getElementById('recurringElement').style.display = 'block';
    toggleRecurring(false);
  }

  function submitTransaction(event) {
    if (event.target.recurringCheck.checked) submitRecurringAdd(event);
    else submitTransactionAdd(event);
  }

  async function submitRecurringAdd(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    data.tags = data.tags ? data.tags.split(',').map(tag => tag.trim()) : [];

    // Check if startDate is before endDate
    if (new Date(data.startDate) >= new Date(data.endDate)) {
      bootstrap.showToast({body: 'The end date must be later than the start date.', delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"});
      return;
    }

    try {
      const response = await fetch(`${API_URL}/recurring`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const json = await response.json()

      if (!response.ok) {
        if (response.status === 422) throw new Error(json.detail[0].msg)
        throw new Error("An error occurred.")
      }
      else {
        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
        modal.hide();

        // Show toast
        bootstrap.showToast({body: 'Recurring transaction added.', delay: 1000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-success"})

        // Refresh the chart
        loadChart();
      }
    }
    catch (error) {
      bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
    }
  }

  async function submitTransactionAdd(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    data.tags = data.tags ? data.tags.split(',').map(tag => tag.trim()) : [];

    try {
      const response = await fetch(`${API_URL}/transactions`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }

      const json = await response.json()

      if (!response.ok) {
        if (response.status === 422) throw new Error(json.detail[0].msg)
        throw new Error("An error occurred.")
      }
      else {
        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
        modal.hide();

        // Show toast
        bootstrap.showToast({body: 'Transaction added.', delay: 1000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-success"})

        // Refresh the chart
        loadChart();
      }
    }
    catch (error) {
      bootstrap.showToast({body: `${error}`, delay: 3000, position: "top-0 start-50 translate-middle-x", toastClass: "text-bg-danger"})
    }
  }

  function toggleRecurring(enabled) {
    const recurringDiv = document.getElementById('recurringDiv');
    const date = document.getElementById('dateInput');
    const startDate = document.getElementById('startDateInput');
    const endDate = document.getElementById('endDateInput');
    const frequencySelect = document.getElementById('frequencySelect');

    if (enabled) {
      recurringDiv.style.display = 'block';
      date.disabled = true;
      startDate.value = new Date().toISOString().split('T')[0];
      startDate.required = true;
      endDate.required = true;
      frequencySelect.required = true;
    } else {
      recurringDiv.style.display = 'none';
      date.disabled = false;
      startDate.required = false;
      endDate.required = false;
      frequencySelect.required = false;
    }
  }

  // --------
  // - AUTH -
  // --------
  async function checkLogin() {
    const response = await fetch(`${API_URL}/login/check`, {
      method: 'GET',
      credentials: 'include',
    });

    if (response.status === 401) {
      window.location.href = '/login';
      return;
    }

    const enabled = await response.json()
    if (enabled) document.getElementById('logoutButton').style.display = 'block'
  }

  async function logout() {
    await fetch(`${API_URL}/logout`, { method: 'POST', credentials: 'include' });
    window.location.href = '/login';
  }
</script>
</html>